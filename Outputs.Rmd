---
knit: (function(inputFile, encoding) { 
          rmarkdown::render(inputFile,
                        encoding=encoding, 
                output_file='Outputs.html') })
---

#### Planning for COVID-19 in Baltimore City

Prepared by [SORT](https://www.jhsph.edu/departments/epidemiology/tracks/infectious-disease-epidemiology/sort/) from Johns Hopkins  
Updated `r Sys.Date()`

```{r setup, include=FALSE, eval=TRUE}
options(tinytex.verbose = TRUE, scipen = 999)
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, warning=FALSE, message=FALSE, fig.align="center")
```

**This report is based on mathematical models of transmission, and is not a forecast of the epidemic trajectory. Rather, these estimates should be used to help guide decision making regarding prevention, mitigation and preparedness strategies. Results are specific to Baltimore City. This is a living document and can be updated to reflect changes in our understanding of the SARS-CoV-2 virus and public health interventions in the region.** 

**Purpose**
<br>
The purpose of this report is to compare the health impact and surge capacity needs for the 2020 COVID-19 epidemic in Baltimore City. We use a stochastic age-structured Susceptible Exposed Infected Recovered (SEIR) model to predict the number of incident cases within age groups, and among healthcare workers and the homeless population. We then use our best understanding of the natural history of SARS-CoV2 to estimate the number of hospitalizations, ICU admissions, ventilators required, and deaths in Baltimore City. 

We compare three intervention strategies under two transmission scenarios for model simulations from February 1, 2020 through November 30, 2020. The transmission scenarios are:

- Low transmission scenario where $R_0$ is assumed to be between 1.5-2.5.
- High transmission scenario where $R_0$ is assumed to be between 2.5-3.5.

Within each scenario we considered the following three intervention strategies:

(A) Uncontrolled worst-case scenario (Uncontrolled): In this strategy the epidemic is allowed to spread uncontrolled with no interventions or indivudual behavior change.
(B) Mildly restrictive social distancing followed by uncontrolled spread (Mild): This strategy has relaxed social distancing from March 20 through May 15 (30-40% reduction in $R_0$) and then returns to uncontrolled transmission.
(C) Moderately restrictive social distancing followed by targeted testing and isolation (Moderate + Testing): This strategy has moderately restrictive social distancing similar to that in US cities during the 1918 influenza pandemic from March 20 through May 15 (44-65% reduction in $R_0$). From May 16 through November 30, there is a targeted test and isolate strategy similar to that implemented in South Korea (48-76% reduction in $R_0$).

**Assumptions**
<br>
Given the limited amount of information on some of the key epidemiologic features of COVID-19, we have used commonly accepted estimates in the literature thus far and believe these are appropriate for planning purposes. These assumptions are subject to change as new information becomes available. Specific details regarding the methods and assumptions used in this report are provided in the technical appendix.


```{r data, include=FALSE, eval=TRUE, echo=FALSE}

setwd("~/Dropbox/Postdoc/COVID19/COVID-BaltimoreCity/output_20200405")

require(socialmixr)
require(xlsx)
require(magrittr)
require(stringr)
require(reshape2)
require(dplyr)
require(ggplot2) 
require(tidyr)
require(xtable)
require(cowplot)
require(stringr)

##load data
complete_scenario1A <- read.csv("scenario1A_lowR0_uncontrolled.csv")
complete_scenario1B <- read.csv("scenario1B_lowR0_MildDistancing.csv")
complete_scenario1C <- read.csv("scenario1C_lowR0_ModDistancing.csv")
complete_scenario2A <- read.csv("scenario2A_highR0_uncontrolled.csv")
complete_scenario2B <- read.csv("scenario2B_highR0_MildDistancing.csv")
complete_scenario2C <- read.csv("scenario2C_highR0_ModDistancing.csv")

##load_and_clean function to concatenate age categories

load_and_clean<- function(data, r0val){
  complete_incident_r0val<- data%>%
    select(time,incid_I1,incid_I2,incid_I3,incid_I4,incid_I5,
         incid_I6,incid_I7,incid_I8,incid_I9,
         incid_I10,incid_I11,incid_I12,incid_I13,incid_I14)
  
  combined_incident_r0val<- complete_incident_r0val%>%
        mutate(cat1=rowSums(.[2:5]))%>%
        mutate(cat2=rowSums(.[6:8]))%>%
        mutate(cat3=rowSums(.[9]))%>%
        mutate(cat4=rowSums(.[10:12]))%>%
        mutate(cat5=rowSums(.[13]))%>%
        mutate(cat6=rowSums(.[14]))%>%
        mutate(cat7=rowSums(.[15]))
  
  combined_incident_r0val<- combined_incident_r0val%>%
    select(time, cat1, cat2, cat3, cat4, cat5, cat6, cat7)
  
  return(combined_incident_r0val)
}

##run the function on each transmission scenario
combined_incident_R0lowA<- load_and_clean(complete_scenario1A,R0lowA)  
combined_incident_R0lowB<- load_and_clean(complete_scenario1B,R0lowB)  
combined_incident_R0lowC<- load_and_clean(complete_scenario1C,R0lowC)  
combined_incident_R0highA<- load_and_clean(complete_scenario2A,R0highA)  
combined_incident_R0highB<- load_and_clean(complete_scenario2B,R0highB)  
combined_incident_R0highC<- load_and_clean(complete_scenario2C,R0highC)  


```


```{r, message=FALSE, warning=FALSE, echo=FALSE}

#Here we create a probability matrix of working probabilities from the literature for the probability of becoming a hospitalized case, getting admitted to ICU, needing a ventilator and death. These are nested conditional probabilities that rely on the following assumptions:
#The percentage of hospitalized cases in each category is obtained from the [CDC](https://www.cdc.gov/mmwr/volumes/69/wr/mm6912e2.htm#T1_down) where we combined the 55-74 age groups and the 75-80 and 80+ age groups.
#We assume the remainder of the nested probabilities from the [CDC](https://www.cdc.gov/mmwr/volumes/69/wr/mm6912e2.htm#T1_down) and in each subsequent state (hospitalization to ICU, ICU to death) we shift the denominator to be the preceding state's total (e.g. the probability of getting admitted to the ICU is the number of ICU cases for the age group/number of hospitalized cases for the age group).
#We assume a global probability that 25% of cases admitted to the ICU require a ventilator per [WHO reports](https://www.who.int/publications-detail/report-of-the-who-china-joint-mission-on-coronavirus-disease-2019-(covid-19)).  
#We assume healthcare workers and the homeless population follow a similar nested probability scheme as those in the 45-54 year age group.
#Note: Instead of having just a point estimate from the CDC table as described we take this point estmate to be the mean of a beta distribution, where the second shape parameter is 1. The first shape parameter is then defined by (mean)/(1-mean) where the mean is the point estimate of the nested probability obtained from the CDC table.


prob_severe<- c(0.0256,0.263,0.395,0.577,1.732,0.577,0.577)

prob_hospitalized<- rep(1,7)

prob_ICU<- c(0,0.253,0.582,0.686,0.908,0.582,0.582)

prob_dead_from_icu<-c(0,0.041,0.071,0.217,0.445,0.071,0.071)

prob_vent_icu<- c(0,0.035,0.059,0.214,0.912,0.059,0.059)

prob_dead_from_vent<- c(0,0.33,0.25,0.692,1.27,0.25,0.25)

prob_matrix<- cbind(prob_severe,prob_hospitalized,prob_ICU,prob_dead_from_icu,
                     prob_vent_icu,prob_dead_from_vent)

#define number of days simulations run for
n_days <- 300
```


```{r, message=FALSE, echo=FALSE, warning=FALSE}

##### Estimate number of hospitalizations, ICU admissions, ventilators used, and deaths

incident_classifications<- function(data, complete_data, R0val){
  counts_array_R0val<- array(NA, dim=c(nrow(data),ncol(data),5))
  counts_array_R0val[,1,]<- data$time
  
for(i in 2:ncol(data)){
  
  for(j in 1:n_days){
    if(j<=4){
counts_array_R0val[which(complete_data$time==j),i,1]<- 
      data[complete_data$time==j,i,1]*prob_matrix[i-1,1]
}
  else{
    counts_array_R0val[which(complete_data$time==j),i,1]<- 
      data[complete_data$time==(j-4),i,1]*prob_matrix[i-1,1]
  }


  }  
 counts_array_R0val[,i,2]<- counts_array_R0val[,i,1]*prob_matrix[i-1,2] 
 
for(k in 1:n_days){
     if(k<=4){      
counts_array_R0val[which(complete_data$time==k),i,3]<- 
      counts_array_R0val[which(complete_data$time==k),i,2]*prob_matrix[i-1,3]
     }
  else{
   counts_array_R0val[which(complete_data$time==k),i,3]<- 
      counts_array_R0val[which(complete_data$time==(k-4)),i,2]*prob_matrix[i-1,3] 
  }
}
 
 for(l in 1:n_days){
        if(l<=3){
counts_array_R0val[which(complete_data$time==l),i,4]<- 
      counts_array_R0val[which(complete_data$time==(l)),i,3]*prob_matrix[i-1,5] 
        }
   else{
     counts_array_R0val[which(complete_data$time==l),i,4]<- 
      counts_array_R0val[which(complete_data$time==(l-3)),i,3]*prob_matrix[i-1,5] 
   }
 }
 
 for(m in 1:n_days){
   if(m<=5){
     counts_array_R0val[which(complete_data$time==m),i,5]<- 
      (counts_array_R0val[which(complete_data$time==(m)),i,3]*prob_matrix[i-1,4])+(counts_array_R0val[which(complete_data$time==(m)),i,4]*prob_matrix[i-1,6])
   }
   
 else if(m>5&m<=8){
   counts_array_R0val[which(complete_data$time==m),i,5]<- 
      (counts_array_R0val[which(complete_data$time==(m)),i,3]*prob_matrix[i-1,4])+(counts_array_R0val[which(complete_data$time==(m-5)),i,4]*prob_matrix[i-1,6])
 }
 else{
   counts_array_R0val[which(complete_data$time==m),i,5]<- 
      (counts_array_R0val[which(complete_data$time==(m-8)),i,3]*prob_matrix[i-1,4])+(counts_array_R0val[which(complete_data$time==(m-5)),i,4]*prob_matrix[i-1,6])
 }
 }
}

return(counts_array_R0val)

}

counts_array_R0lowA<- incident_classifications(combined_incident_R0lowA,complete_scenario1A,R0lowA)
counts_array_R0lowB<- incident_classifications(combined_incident_R0lowB,complete_scenario1B,R0lowB)
counts_array_R0lowC<- incident_classifications(combined_incident_R0lowC,complete_scenario1C,R0lowC)
counts_array_R0highA<- incident_classifications(combined_incident_R0highA,complete_scenario2A,R0highA)
counts_array_R0highB<- incident_classifications(combined_incident_R0highB,complete_scenario2B,R0highB)
counts_array_R0highC<- incident_classifications(combined_incident_R0highC,complete_scenario2C,R0highC)

```


```{r,message=FALSE, warning=FALSE, echo=FALSE}

##define the point estimates of how long people stay in each of the state   
length_of_stay<- c(NA,11,11,11,NA)

##cumulative_counts function
cumulative_counts<- function(data, R0val){
  cumulative_array_R0val<- array(NA, dim=dim(data))
  
  cumulative_array_R0val[,1,]<- data[,1,]

  for(j in 2:dim(cumulative_array_R0val)[2]){
    cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==1),j,]<-
      data[which(data[,1,1]==1),j,]
    
    for(i in 2:n_days){
      cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==i),j,1]<-
        cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==(i-1)),j,1]+
        data[which(data[,1,1]==i),j,1]
      cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==i),j,5]<-
        cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==(i-1)),j,5]+
        data[which(data[,1,1]==i),j,5]
    }

    for(k in 2:n_days){
      if(k<=length_of_stay[2]){
      cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==k),j,2]<-
        cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==(k-1)),j,2]+
        data[which(data[,1,1]==k),j,2]
      }
      else {
        cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==k),j,2]<-
          cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==k-1),j,2]+
          data[which(data[,1,1]==k),j,2]-data[which(data[,1,1]==(k-length_of_stay[2])),j,2]
      }
    }
  for(l in 2:n_days){
      if(l <= length_of_stay[3]){
        cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==l),j,3]<-
          cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==(l-1)),j,3]+
          data[which(data[,1,1]==l),j,3]
      }
    else{
      cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==l),j,3]<-
        cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==(l-1)),j,3]+
          data[which(data[,1,1]==l),j,3]-data[which(data[,1,1]==(l-length_of_stay[3])),j,3]
    }
  }
    for(m in 2:n_days){
    if(m<=length_of_stay[4]){
      cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==m),j,4]<-
        cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==(m-1)),j,4]+
        data[which(data[,1,1]==m),j,4]
    }
    else{
      cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==m),j,4]<-
        cumulative_array_R0val[which(cumulative_array_R0val[,1,1]==(m-1)),j,4]+
          data[which(data[,1,1]==m),j,4]-data[which(data[,1,1]==(m-length_of_stay[4])),j,4]
      }
    }
   
}
return(cumulative_array_R0val)
  
}

cumulative_array_R0lowA<- cumulative_counts(counts_array_R0lowA,R0lowA)
cumulative_array_R0lowB<- cumulative_counts(counts_array_R0lowB,R0lowB)
cumulative_array_R0lowC<- cumulative_counts(counts_array_R0lowC,R0lowC)
cumulative_array_R0highA<- cumulative_counts(counts_array_R0highA,R0highA)
cumulative_array_R0highB<- cumulative_counts(counts_array_R0highB,R0highB)
cumulative_array_R0highC<- cumulative_counts(counts_array_R0highC,R0highC)

```


```{r, message=FALSE, warning-FALSE, echo=FALSE}

median_incident_symptomatic<- function(data, R0val){
  median_incident_combined_R0val<- matrix(NA,n_days,ncol(data))

    for(i in 1:nrow(median_incident_combined_R0val)){
      median_incident_combined_R0val[i,]<-
        apply(data[which(data[,1]==i),],2,median)
    }
  upper_incident_combined_R0val<- matrix(NA,n_days,ncol(data))

    for(i in 1:nrow(upper_incident_combined_R0val)){
      upper_incident_combined_R0val[i,]<-
        apply(data[which(data[,1]==i),],2,quantile, probs=(0.75), na.rm=TRUE)
    }
  
  lower_incident_combined_R0val<- matrix(NA,n_days,ncol(data))

    for(i in 1:nrow(lower_incident_combined_R0val)){
      lower_incident_combined_R0val[i,]<-
        apply(data[which(data[,1]==i),],2,quantile, probs=(0.25), na.rm=TRUE)
    }
  
  
  return(list(median_incident_combined_R0val, upper_incident_combined_R0val,
              lower_incident_combined_R0val))
  }

incident_symptomatic_R0lowA<- median_incident_symptomatic(combined_incident_R0lowA,R0lowA)
median_incident_symptomatic_R0lowA<- incident_symptomatic_R0lowA[[1]]
upper_incident_symptomatic_R0lowA<- incident_symptomatic_R0lowA[[2]]
lower_incident_symptomatic_R0lowA<- incident_symptomatic_R0lowA[[3]]
incident_symptomatic_R0lowB<- median_incident_symptomatic(combined_incident_R0lowB,R0lowB)
median_incident_symptomatic_R0lowB<- incident_symptomatic_R0lowB[[1]]
upper_incident_symptomatic_R0lowB<- incident_symptomatic_R0lowB[[2]]
lower_incident_symptomatic_R0lowB<- incident_symptomatic_R0lowB[[3]]
incident_symptomatic_R0lowC<- median_incident_symptomatic(combined_incident_R0lowC,R0lowC)
median_incident_symptomatic_R0lowC<- incident_symptomatic_R0lowC[[1]]
upper_incident_symptomatic_R0lowC<- incident_symptomatic_R0lowC[[2]]
lower_incident_symptomatic_R0lowC<- incident_symptomatic_R0lowC[[3]]

incident_symptomatic_R0highA<- median_incident_symptomatic(combined_incident_R0highA,R0highA)
median_incident_symptomatic_R0highA<- incident_symptomatic_R0highA[[1]]
upper_incident_symptomatic_R0highA<- incident_symptomatic_R0highA[[2]]
lower_incident_symptomatic_R0highA<- incident_symptomatic_R0highA[[3]]
incident_symptomatic_R0highB<- median_incident_symptomatic(combined_incident_R0highB,R0highB)
median_incident_symptomatic_R0highB<- incident_symptomatic_R0highB[[1]]
upper_incident_symptomatic_R0highB<- incident_symptomatic_R0highB[[2]]
lower_incident_symptomatic_R0highB<- incident_symptomatic_R0highB[[3]]
incident_symptomatic_R0highC<- median_incident_symptomatic(combined_incident_R0highC,R0highC)
median_incident_symptomatic_R0highC<- incident_symptomatic_R0highC[[1]]
upper_incident_symptomatic_R0highC<- incident_symptomatic_R0highC[[2]]
lower_incident_symptomatic_R0highC<- incident_symptomatic_R0highC[[3]]


####################################################################

median_counts_array<- function(data, R0val){
  median_counts_array<- array(NA, dim=c(n_days,dim(data)[2], dim(data)[3]))
  
  for(i in 1:dim(median_counts_array)[3]){
    for(j in 1:dim(median_counts_array)[1]){
      median_counts_array[j,,i]<- apply(data[which(data[,1,1]==j),,i],2,median)
    }
  }
 
   upper_counts_array<- array(NA, dim=c(n_days,dim(data)[2], dim(data)[3]))
  
  for(i in 1:dim(upper_counts_array)[3]){
    for(j in 1:dim(upper_counts_array)[1]){
      upper_counts_array[j,,i]<- apply(data[which(data[,1,1]==j),,i],2,quantile, prob=0.75,na.rm=T)
    }
  } 
   
    lower_counts_array<- array(NA, dim=c(n_days,dim(data)[2], dim(data)[3]))
  
  for(i in 1:dim(lower_counts_array)[3]){
    for(j in 1:dim(lower_counts_array)[1]){
      lower_counts_array[j,,i]<- apply(data[which(data[,1,1]==j),,i],2,quantile, prob=0.25,na.rm=T)
    }
  } 
    return(list(median_counts_array, upper_counts_array,lower_counts_array))
}

summary_counts_array_R0lowA<- median_counts_array(counts_array_R0lowA,R0lowA)
median_counts_array_R0lowA<- summary_counts_array_R0lowA[[1]]
upper_counts_array_R0lowA<- summary_counts_array_R0lowA[[2]]
lower_counts_array_R0lowA<- summary_counts_array_R0lowA[[3]]
summary_counts_array_R0lowB<- median_counts_array(counts_array_R0lowB,R0lowB)
median_counts_array_R0lowB<- summary_counts_array_R0lowB[[1]]
upper_counts_array_R0lowB<- summary_counts_array_R0lowB[[2]]
lower_counts_array_R0lowB<- summary_counts_array_R0lowB[[3]]
summary_counts_array_R0lowC<- median_counts_array(counts_array_R0lowC,R0lowC)
median_counts_array_R0lowC<- summary_counts_array_R0lowC[[1]]
upper_counts_array_R0lowC<- summary_counts_array_R0lowC[[2]]
lower_counts_array_R0lowC<- summary_counts_array_R0lowC[[3]]

summary_counts_array_R0highA<- median_counts_array(counts_array_R0highA,R0highA)
median_counts_array_R0highA<- summary_counts_array_R0highA[[1]]
upper_counts_array_R0highA<- summary_counts_array_R0highA[[2]]
lower_counts_array_R0highA<- summary_counts_array_R0highA[[3]]
summary_counts_array_R0highB<- median_counts_array(counts_array_R0highB,R0highB)
median_counts_array_R0highB<- summary_counts_array_R0highB[[1]]
upper_counts_arrayc_R0highB<- summary_counts_array_R0highB[[2]]
lower_counts_array_R0highB<- summary_counts_array_R0highB[[3]]
summary_counts_array_R0highC<- median_counts_array(counts_array_R0highC,R0highC)
median_counts_array_R0highC<- summary_counts_array_R0highC[[1]]
upper_counts_array_R0highC<- summary_counts_array_R0highC[[2]]
lower_counts_array_R0highC<- summary_counts_array_R0highC[[3]]


########################################

median_cumulative_array<- function(data, R0val){
  median_cumulative_array<- array(NA, dim=c(n_days,dim(data)[2], dim(data)[3]))
  
  for(i in 1:dim(median_cumulative_array)[3]){
    for(j in 1:dim(median_cumulative_array)[1]){
      median_cumulative_array[j,,i]<- apply(data[which(data[,1,1]==j),,i],2,median,na.rm=T)
    }
  }
 
   upper_cumulative_array<- array(NA, dim=c(n_days,dim(data)[2], dim(data)[3]))
  
  for(i in 1:dim(upper_cumulative_array)[3]){
    for(j in 1:dim(upper_cumulative_array)[1]){
      upper_cumulative_array[j,,i]<- apply(data[which(data[,1,1]==j),,i],2,quantile, prob=0.75,na.rm=T)
    }
  } 
   
    lower_cumulative_array<- array(NA, dim=c(n_days,dim(data)[2], dim(data)[3]))
  
  for(i in 1:dim(lower_cumulative_array)[3]){
    for(j in 1:dim(lower_cumulative_array)[1]){
      lower_cumulative_array[j,,i]<- apply(data[which(data[,1,1]==j),,i],2,quantile, prob=0.25,na.rm=T)
    }
  } 
    return(list(median_cumulative_array, upper_cumulative_array,lower_cumulative_array))
}


summary_cumulative_array_R0lowA<- median_cumulative_array(cumulative_array_R0lowA,R0lowA)
median_cumulative_array_R0lowA<- summary_cumulative_array_R0lowA[[1]]
upper_cumulative_array_R0lowA<- summary_cumulative_array_R0lowA[[2]]
lower_cumulative_array_R0lowA<- summary_cumulative_array_R0lowA[[3]]
summary_cumulative_array_R0lowB<- median_cumulative_array(cumulative_array_R0lowB,R0lowB)
median_cumulative_array_R0lowB<- summary_cumulative_array_R0lowB[[1]]
upper_cumulative_array_R0lowB<- summary_cumulative_array_R0lowB[[2]]
lower_cumulative_array_R0lowB<- summary_cumulative_array_R0lowB[[3]]
summary_cumulative_array_R0lowC<- median_cumulative_array(cumulative_array_R0lowC,R0lowC)
median_cumulative_array_R0lowC<- summary_cumulative_array_R0lowC[[1]]
upper_cumulative_array_R0lowC<- summary_cumulative_array_R0lowC[[2]]
lower_cumulative_array_R0lowC<- summary_cumulative_array_R0lowC[[3]]

summary_cumulative_array_R0highA<- median_cumulative_array(cumulative_array_R0highA,R0highA)
median_cumulative_array_R0highA<- summary_cumulative_array_R0highA[[1]]
upper_cumulative_array_R0highA<- summary_cumulative_array_R0highA[[2]]
lower_cumulative_array_R0highA<- summary_cumulative_array_R0highA[[3]]
summary_cumulative_array_R0highB<- median_cumulative_array(cumulative_array_R0highB,R0highB)
median_cumulative_array_R0highB<- summary_cumulative_array_R0highB[[1]]
upper_cumulative_array_R0highB<- summary_cumulative_array_R0highB[[2]]
lower_cumulative_array_R0highB<- summary_cumulative_array_R0highB[[3]]
summary_cumulative_array_R0highC<- median_cumulative_array(cumulative_array_R0highC,R0highC)
median_cumulative_array_R0highC<- summary_cumulative_array_R0highC[[1]]
upper_cumulative_array_R0highC<- summary_cumulative_array_R0highC[[2]]
lower_cumulative_array_R0highC<- summary_cumulative_array_R0highC[[3]]

```

 -------------------------------

**Key Questions and Findings** 

*Question 1: When and how big are the peaks of infection, hospitalization, and death?*

*Important considerations:*

- We differentiate between asymptomatic and symptomatic infections and consider that a different ratio of asymptomatic:symptomatic cases exists by age group. Early evidence from six countries suggests that the probability of manifesting clinical symptoms may be positively related with age, with symptoms in approximately 20% of children under 10 and in over 70% of older adults [Davies et al. 2020](https://www.medrxiv.org/content/10.1101/2020.03.24.20043018v1.full.pdf).
- We run 500 simulations for each intervention strategy of each transmission scenario. This allows us to examine the variability in our model estimates. We visualize this by displaying 15 random simulations in our figures in addition to the median of all simulations.
- The magnitude and timing of the peak will depend heavily on the transmission scenario. 

**Figure 1.** The number of incident infections under the A) low and B) high transmission scenarios for each intervention strategy. The dark line represents the median of 500 simulations per strategy and scenario and the dotted lines represent the 15 random simulations.

```{r,message=FALSE, echo=FALSE, warning=FALSE}

make_fig_1<- function(complete_data_1,complete_data_2,complete_data_3,
                      median_data_1,median_data_2,median_data_3,
                      combined_data_1,combined_data_2,combined_data_3){
random_sample_R017<- which(complete_data_1$run_index%in%sample(rep(1:500),15,replace=F))
random_sample_R021<- which(complete_data_2$run_index%in%sample(rep(1:500), 15, replace=F))
random_sample_R025<- which(complete_data_3$run_index%in%sample(rep(1:500), 15, replace = F))


incident_symptomatic_wide<- as.data.frame(cbind(median_data_1[,1],
                            apply(median_data_1[,-1],1,sum),
                            apply(median_data_2[,-1],1,sum),
                            apply(median_data_3[,-1],1,sum)))

colnames(incident_symptomatic_wide)<- c("Day", "R_0=1.7,Median", "R_0=2.1,Median", "R_0=2.5,Median") 

random_sims<- as.data.frame(cbind(combined_data_1[random_sample_R017,1],
                                apply(combined_data_1[random_sample_R017,-1],1,sum),
                                apply(combined_data_2[random_sample_R021,-1],1,sum),
                                apply(combined_data_3[random_sample_R021,-1],1,sum)))

colnames(random_sims)<- c("Day","R_0=1.7,Random", "R_0=2.1,Random", "R_0=2.5,Random")


incident_symptomatic_long<- incident_symptomatic_wide%>%
  gather(scenario, incident_symptomatic, "R_0=1.7,Median":"R_0=2.5,Median", factor_key = TRUE)

random_sims_long<- random_sims%>%
  gather(scenario, incident_symptomatic, "R_0=1.7,Random":"R_0=2.5,Random", factor_key=TRUE)


symptomatic_df<- as.data.frame(rbind(incident_symptomatic_long,random_sims_long))

symptomatic_df_sep<- symptomatic_df%>%
  separate(scenario, into=c("scenario", "summary_stat"), sep=",")%>%
  mutate(scenario=ifelse(scenario=="R_0=1.7", "Uncontrolled",
                         ifelse(scenario=="R_0=2.1", "Mildly restrictive", 
                                "Moderately restrictive")))%>%
  mutate(Day=rep(seq(as.Date('2020/02/1'),by='day',length.out=n_days),48))



plt_incident_cases<- ggplot(symptomatic_df_sep)+ 
  geom_line(aes(y= incident_symptomatic, x=Day,color=str_wrap(scenario,10),linetype=summary_stat))+
  #geom_ribbon(aes(ymax=upper,ymin=lower,x=Day,fill=scenario), alpha=.5) +
  labs(title="Incident Symptomatic Cases Per Day",y="Number of Cases") +
  labs(color="Strategy",linetype="Summary Statistic") 
return(list(plt_incident_cases,random_sample_R017,random_sample_R021,random_sample_R025))

}

f_1_low<- make_fig_1(complete_scenario1A,complete_scenario1B,complete_scenario1C,
           median_incident_symptomatic_R0lowA,median_incident_symptomatic_R0lowB,
           median_incident_symptomatic_R0lowC,
           combined_incident_R0lowA,combined_incident_R0lowB,combined_incident_R0lowC)

f_1_high<- make_fig_1(complete_scenario2A,complete_scenario2B,complete_scenario2C,
           median_incident_symptomatic_R0highA,median_incident_symptomatic_R0highB,
           median_incident_symptomatic_R0highC,
           combined_incident_R0highA,combined_incident_R0highB,combined_incident_R0highC)

```


<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>

<div class = "row"><div class = "col-md-6"><div class = "blue">
- In the low transmission scenario, the peak when no intervention strategies are used is expected X days after the start of the epidemic with XX incident infections. 
- When a mildly restrictive intervention strategy is employed, the peak is shifted and expected to occur X days after the start of the epidemic with XX daily incident infections. 
- When a moderately restrictive intervention strategy is employed, the epidemic does not take off.
</div></div>

<div class = "col-md-6">
```{r,message=FALSE, echo=FALSE, warning=FALSE, fig.align="center", fig.cap="Figure 1A."}

plt <- cowplot::plot_grid(f_1_low[[1]] , labels=c('A'), align = "h", nrow=1)
print(plt)

```
</div>
</div>

<br><br>

<div class = "row"><div class = "col-md-6"><div class = "blue">
- In the high transmission scenario, the peak when no intervention strategies are used is expected X days after the start of the epidemic with the peak number of incident infections is markedly higher compared to the low transmission scenario. 
- Employing a mildly restrictive intervention strategy only delays the the peak of infections, but does not significantly reduce the number of incident cases. 
- When a moderately restrictive intervention strategy is employed, the epidemic is slow to take off and remains relatively flat.
</div></div>

<div class = "col-md-6">
```{r,message=FALSE, echo=FALSE, warning=FALSE, fig.align="center", fig.cap="Figure 1B."}

plt <- cowplot::plot_grid(f_1_high[[1]] , labels=c('B'), align = "h", nrow=1)
print(plt)

```
</div>
</div>

<br><br>

*Important considerations:*

- Our estimate of how many incident infections become severe and get hospitalized does not consider the prevalence of co-morbidities like diabetes and hypertension in the population. Though we consider the age structure of Baltimore and age-specific hospitalization rates from the CDC, our estimates of who gets hospitalized and experiences severe disease may be biased.

**Figure 2.** The number of incident hospitalizations under the A) low and B) high transmission scenarios for each intervention strategy. The dark line represents the median of 500 simulations per strategy and scenario and the dotted lines represent the 15 random simulations.

```{r, message=FALSE, warning=FALSE, echo=FALSE}

make_fig_2<- function(random_sample_1,random_sample_2,random_sample_3,
                      counts_data_1,counts_data_2,counts_data_3,
                      median_counts_data_1,median_counts_data_2,median_counts_data_3){


incident_hosp_wide<- as.data.frame(cbind(median_counts_data_1[,1,1],
                            apply(median_counts_data_1[,-1,1],1,sum),
                            apply(median_counts_data_2[,-1,1],1,sum),
                            apply(median_counts_data_3[,-1,1],1,sum)))

colnames(incident_hosp_wide)<- c("Day", "R_0=1.7,Median", "R_0=2.1,Median", "R_0=2.5,Median") 

random_sims<- as.data.frame(cbind(counts_data_1[random_sample_1,1,1],
                                apply(counts_data_1[random_sample_1,-1,1],1,sum),
                                apply(counts_data_2[random_sample_2,-1,1],1,sum),
                                apply(counts_data_3[random_sample_3,-1,1],1,sum)))

colnames(random_sims)<- c("Day","R_0=1.7,Random", "R_0=2.1,Random", "R_0=2.5,Random")


incident_hosp_long<- incident_hosp_wide%>%
  gather(scenario, incident_hosp, "R_0=1.7,Median":"R_0=2.5,Median", factor_key = TRUE)

random_sims_long<- random_sims%>%
  gather(scenario, incident_hosp, "R_0=1.7,Random":"R_0=2.5,Random", factor_key=TRUE)


hosp_df<- as.data.frame(rbind(incident_hosp_long,random_sims_long))

hosp_df_sep<- hosp_df%>%
  separate(scenario, into=c("scenario", "summary_stat"), sep=",")%>%
  mutate(scenario=ifelse(scenario=="R_0=1.7", "Uncontrolled",
                         ifelse(scenario=="R_0=2.1", "Mildly restrictive", 
                                "Moderately restrictive")))%>%
  mutate(Day=rep(seq(as.Date('2020/02/1'),by='day',length.out=n_days),48))



plt_hosp_cases<- ggplot(hosp_df_sep)+ 
  geom_line(aes(y= incident_hosp, x=Day,color=str_wrap(scenario,10),linetype=summary_stat))+
  #geom_ribbon(aes(ymax=upper,ymin=lower,x=Day,fill=scenario), alpha=.5) +
  labs(title="Incident Hospitalizations Per Day",y="Number of Hospitalizations") +
  labs(color="Strategy",linetype="Summary Statistic") 
return(plt_hosp_cases)
}

f_2_low<- make_fig_2(f_1_low[[2]],f_1_low[[3]],f_1_low[[4]],
                 counts_array_R0lowA,counts_array_R0lowB,counts_array_R0lowC,
                 median_counts_array_R0lowA,median_counts_array_R0lowB,median_counts_array_R0lowC)

f_2_high<- make_fig_2(f_1_high[[2]],f_1_high[[3]],f_1_high[[4]],
                 counts_array_R0highA,counts_array_R0highB,counts_array_R0highC,
                 median_counts_array_R0highA,median_counts_array_R0highB,median_counts_array_R0highC)

```


<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>

<div class = "row"><div class = "col-md-6"><div class = "blue">
- In the low transmission scenario, the peak of incident hospitalizations when no intervention strategies are used is expected X days after the start of the epidemic. 
- When a mildly restrictive intervention strategy is employed, the peak is shifted and expected to occur X days after the start of the epidemic with XX daily incident hospitalizations. 
</div></div>

<div class = "col-md-6">
```{r,message=FALSE, echo=FALSE, warning=FALSE, fig.align="center", fig.cap="Figure 2A."}

plt <- cowplot::plot_grid(f_2_low, labels=c('A'), align = "h", nrow=1)
print(plt)

```
</div>
</div>

<br><br>

<div class = "row"><div class = "col-md-6"><div class = "blue">
- In the high transmission scenario, the peak of incident hospitalizations when no intervention strategies are used is expected X days after the start of the epidemic. 
- When a mildly restrictive intervention strategy is employed, the peak is shifted and expected to occur X days after the start of the epidemic with XX daily incident hospitalizations. 
- When a moderately restrictive intervention strategy is employed, the epidemic is slow to take off and hospitalizations remain manageable.
</div></div>

<div class = "col-md-6">
```{r,message=FALSE, echo=FALSE, warning=FALSE, fig.align="center", fig.cap="Figure 2B."}

plt <- cowplot::plot_grid(f_2_high , labels=c('B'), align = "h", nrow=1)
print(plt)

```
</div>
</div>

<br><br>

*Important considerations:*

- We assume there are no deaths among individuals with asymptomatic and mild infections.
- Our estimate does not consider the high prevalence of co-morbidities like diabetes and hypertension and any related increased likelihood of death in this population. 

**Figure 3.** The number of incident deaths under the A) low and B) high transmission scenarios for each intervention strategy. The dark line represents the median of 500 simulations per strategy and scenario and the dotted lines represent the 15 random simulations.

```{r, message=FALSE, warning=FALSE, echo=FALSE}

make_fig_3<- function(random_sample_1,random_sample_2,random_sample_3,
                      counts_data_1,counts_data_2,counts_data_3,
                      median_counts_data_1,median_counts_data_2,median_counts_data_3){


incident_death_wide<- as.data.frame(cbind(median_counts_data_1[,1,5],
                            apply(median_counts_data_1[,-1,5],1,sum),
                            apply(median_counts_data_2[,-1,5],1,sum),
                            apply(median_counts_data_3[,-1,5],1,sum)))

colnames(incident_death_wide)<- c("Day", "R_0=1.7,Median", "R_0=2.1,Median", "R_0=2.5,Median") 

random_sims<- as.data.frame(cbind(counts_data_1[random_sample_1,1,5],
                                apply(counts_data_1[random_sample_1,-1,5],1,sum),
                                apply(counts_data_2[random_sample_2,-1,5],1,sum),
                                apply(counts_data_3[random_sample_3,-1,5],1,sum)))

colnames(random_sims)<- c("Day","R_0=1.7,Random", "R_0=2.1,Random", "R_0=2.5,Random")


incident_death_long<- incident_death_wide%>%
  gather(scenario, incident_death, "R_0=1.7,Median":"R_0=2.5,Median", factor_key = TRUE)

random_sims_long<- random_sims%>%
  gather(scenario, incident_death, "R_0=1.7,Random":"R_0=2.5,Random", factor_key=TRUE)


death_df<- as.data.frame(rbind(incident_death_long,random_sims_long))

death_df_sep<- death_df%>%
  separate(scenario, into=c("scenario", "summary_stat"), sep=",")%>%
  mutate(scenario=ifelse(scenario=="R_0=1.7", "Uncontrolled",
                         ifelse(scenario=="R_0=2.1", "Mildly restrictive", 
                                "Moderately restrictive")))%>%
  mutate(Day=rep(seq(as.Date('2020/02/1'),by='day',length.out=n_days),48))



plt_death_cases<- ggplot(death_df_sep)+ 
  geom_line(aes(y= incident_death, x=Day,color=str_wrap(scenario,10),linetype=summary_stat))+
  #geom_ribbon(aes(ymax=upper,ymin=lower,x=Day,fill=scenario), alpha=.5) +
  labs(title="Incident Deaths Per Day",y="Number of Deaths") +
  labs(color="Strategy",linetype="Summary Statistic") 
return(plt_death_cases)
}

f_3_low<- make_fig_3(f_1_low[[2]],f_1_low[[3]],f_1_low[[4]],
                 counts_array_R0lowA,counts_array_R0lowB,counts_array_R0lowC,
                 median_counts_array_R0lowA,median_counts_array_R0lowB,median_counts_array_R0lowC)

f_3_high<- make_fig_3(f_1_high[[2]],f_1_high[[3]],f_1_high[[4]],
                 counts_array_R0highA,counts_array_R0highB,counts_array_R0highC,
                 median_counts_array_R0highA,median_counts_array_R0highB,median_counts_array_R0highC)

```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>

<div class = "row"><div class = "col-md-6"><div class = "blue">
- In the low transmission scenario, the peak of incident deaths when no intervention strategies are used is expected X days after the start of the epidemic. 
- When a mildly restrictive intervention strategy is employed, the peak is shifted and expected to occur X days after the start of the epidemic with XX daily incident deaths. 
</div></div>

<div class = "col-md-6">
```{r,message=FALSE, echo=FALSE, warning=FALSE, fig.align="center", fig.cap="Figure 3A."}

plt <- cowplot::plot_grid(f_3_low , labels=c('A'), align = "h", nrow=1)
print(plt)

```
</div>
</div>

<br><br>

<div class = "row"><div class = "col-md-6"><div class = "blue">
- In the high transmission scenario, the peak of incident deaths when no intervention strategies are used is expected X days after the start of the epidemic. 
- When a mildly restrictive intervention strategy is employed, the peak is shifted and expected to occur X days after the start of the epidemic with XX daily incident deaths 
</div></div>

<div class = "col-md-6">
```{r,message=FALSE, echo=FALSE, warning=FALSE, fig.align="center", fig.cap="Figure 3B."}

plt <- cowplot::plot_grid(f_3_high , labels=c('B'), align = "h", nrow=1)
print(plt)

```
</div>
</div>

<br><br>


 -------------------------------


*Question 2: Considering new daily infections, discharges, and deaths, what is the daily capacity required for hospital beds, ICU beds, and ventilators?*


*Important considerations:*

- Although it is unlikely that every hospital or ICU beds will be used solely for COVID-19 cases, we assume every hospital and ICU bed are available. We make no assumptions about the number of other severe diseases that may occupy beds.
- These estimates reflect the Baltimore population and do not consider that people from outside Baltimore will seek and require hospitalization in the county.
- Not all infections that require hospitalization will seek care. If home care is common even for severe infections, we would expect a delay in reaching hospital capacity but higher overall mortality.
- We assume cases experience a time lag between illness onset and hospitalization, hospitalization and ICU admission, ICU admission and ventilation, and time to death or discharge. These estimates were gathered from the literature and are listed in the Technical Appendix.


**Figure 4**. Daily A) hospital beds, B) ICU beds, and C) ventilators in use for the low transmission scenario for each intervention strategy. The dark line represents the median of 500 simulations per strategy and scenario and the dotted lines represent the 15 random simulations.

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.align="center", fig.width=6, fig.height=10, fig.cap="Figure 4."}

make_fig_4<- function(random_sample_1,random_sample_2,random_sample_3,
                      cumulative_median_1,cumulative_median_2,cumulative_median_3,
                      cumulative_data_1,cumulative_data_2,cumulative_data_3){
 
cumulative_hosp_wide<- as.data.frame(cbind(cumulative_median_1[,1,2],
                            apply(cumulative_median_1[,-1,2],1,sum),
                            apply(cumulative_median_2[,-1,2],1,sum),
                            apply(cumulative_median_3[,-1,2],1,sum)))

colnames(cumulative_hosp_wide)<- c("Day", "R_0=1.7,Median", "R_0=2.1,Median", "R_0=2.5,Median") 

random_sims<- as.data.frame(cbind(cumulative_data_1[random_sample_1,1,2],
                                apply(cumulative_data_1[random_sample_1,-1,2],1,sum),
                                apply(cumulative_data_2[random_sample_2,-1,2],1,sum),
                                apply(cumulative_data_3[random_sample_3,-1,2],1,sum)))

colnames(random_sims)<- c("Day","R_0=1.7,Random", "R_0=2.1,Random", "R_0=2.5,Random")


cumulative_hosp_long<- cumulative_hosp_wide%>%
  gather(scenario, cumulative_hosp, "R_0=1.7,Median":"R_0=2.5,Median", factor_key = TRUE)

random_sims_long<- random_sims%>%
  gather(scenario, cumulative_hosp, "R_0=1.7,Random":"R_0=2.5,Random", factor_key=TRUE)


cumulative_hosp_df<- as.data.frame(rbind(cumulative_hosp_long,random_sims_long))

cumulative_hosp_df_sep<- cumulative_hosp_df%>%
  separate(scenario, into=c("scenario", "summary_stat"), sep=",")%>%
  mutate(scenario=ifelse(scenario=="R_0=1.7", "Uncontrolled",
                         ifelse(scenario=="R_0=2.1", "Mildly restrictive", 
                                "Moderately restrictive")))%>%
  mutate(Day=rep(seq(as.Date('2020/02/1'),by='day',length.out=n_days),48))



plt_cumulative_hosp<- ggplot(cumulative_hosp_df_sep)+ 
  geom_line(aes(y= cumulative_hosp, x=Day,color=str_wrap(scenario,10),linetype=summary_stat))+
  #geom_ribbon(aes(ymax=upper,ymin=lower,x=Day,fill=scenario), alpha=.5) +
  labs(title="Daily Hospital Bed Use",y="Hospital Beds in Use") +
  labs(color="Strategy",linetype="Summary Statistic") 



###########################
 
cumulative_ICU_wide<- as.data.frame(cbind(cumulative_median_1[,1,3],
                            apply(cumulative_median_1[,-1,3],1,sum),
                            apply(cumulative_median_2[,-1,3],1,sum),
                            apply(cumulative_median_3[,-1,3],1,sum)))

colnames(cumulative_ICU_wide)<- c("Day", "R_0=1.7,Median", "R_0=2.1,Median", "R_0=2.5,Median") 

random_sims<- as.data.frame(cbind(cumulative_data_1[random_sample_1,1,3],
                                apply(cumulative_data_1[random_sample_1,-1,3],1,sum),
                                apply(cumulative_data_2[random_sample_2,-1,3],1,sum),
                                apply(cumulative_data_3[random_sample_3,-1,3],1,sum)))

colnames(random_sims)<- c("Day","R_0=1.7,Random", "R_0=2.1,Random", "R_0=2.5,Random")


cumulative_ICU_long<- cumulative_ICU_wide%>%
  gather(scenario, cumulative_ICU, "R_0=1.7,Median":"R_0=2.5,Median", factor_key = TRUE)

random_sims_long<- random_sims%>%
  gather(scenario, cumulative_ICU, "R_0=1.7,Random":"R_0=2.5,Random", factor_key=TRUE)


cumulative_ICU_df<- as.data.frame(rbind(cumulative_ICU_long,random_sims_long))

cumulative_ICU_df_sep<- cumulative_ICU_df%>%
  separate(scenario, into=c("scenario", "summary_stat"), sep=",")%>%
  mutate(scenario=ifelse(scenario=="R_0=1.7", "Uncontrolled",
                         ifelse(scenario=="R_0=2.1", "Mildly restrictive", 
                                "Moderately restrictive")))%>%
  mutate(Day=rep(seq(as.Date('2020/02/1'),by='day',length.out=n_days),48))



plt_cumulative_ICU<- ggplot(cumulative_ICU_df_sep)+ 
  geom_line(aes(y= cumulative_ICU, x=Day,color=str_wrap(scenario,10),linetype=summary_stat))+
  #geom_ribbon(aes(ymax=upper,ymin=lower,x=Day,fill=scenario), alpha=.5) +
  labs(title="Daily ICU Bed Use",y="ICU Beds in Use") +
  labs(color="Strategy",linetype="Summary Statistic") 

############################
 
cumulative_vent_wide<- as.data.frame(cbind(cumulative_median_1[,1,4],
                            apply(cumulative_median_1[,-1,4],1,sum),
                            apply(cumulative_median_2[,-1,4],1,sum),
                            apply(cumulative_median_3[,-1,4],1,sum)))

colnames(cumulative_vent_wide)<- c("Day", "R_0=1.7,Median", "R_0=2.1,Median", "R_0=2.5,Median") 

random_sims<- as.data.frame(cbind(cumulative_data_1[random_sample_1,1,4],
                                apply(cumulative_data_1[random_sample_1,-1,4],1,sum),
                                apply(cumulative_data_2[random_sample_2,-1,4],1,sum),
                                apply(cumulative_data_3[random_sample_3,-1,4],1,sum)))

colnames(random_sims)<- c("Day","R_0=1.7,Random", "R_0=2.1,Random", "R_0=2.5,Random")


cumulative_vent_long<- cumulative_vent_wide%>%
  gather(scenario, cumulative_vent, "R_0=1.7,Median":"R_0=2.5,Median", factor_key = TRUE)

random_sims_long<- random_sims%>%
  gather(scenario, cumulative_vent, "R_0=1.7,Random":"R_0=2.5,Random", factor_key=TRUE)


cumulative_vent_df<- as.data.frame(rbind(cumulative_vent_long,random_sims_long))

cumulative_vent_df_sep<- cumulative_vent_df%>%
  separate(scenario, into=c("scenario", "summary_stat"), sep=",")%>%
  mutate(scenario=ifelse(scenario=="R_0=1.7", "Uncontrolled",
                         ifelse(scenario=="R_0=2.1", "Mildly restrictive", 
                                "Moderately restrictive")))%>%
  mutate(Day=rep(seq(as.Date('2020/02/1'),by='day',length.out=n_days),48))



plt_cumulative_vent<- ggplot(cumulative_vent_df_sep)+ 
  geom_line(aes(y= cumulative_vent, x=Day,color=str_wrap(scenario,10),linetype=summary_stat))+
  #geom_ribbon(aes(ymax=upper,ymin=lower,x=Day,fill=scenario), alpha=.5) +
  labs(title="Daily Vent Use",y="Vents in Use") +
  labs(color="Strategy",linetype="Summary Statistic") 

return(list(plt_cumulative_hosp,plt_cumulative_ICU,plt_cumulative_vent))

}

f_4_low<- make_fig_4(f_1_low[[2]],f_1_low[[3]],f_1_low[[4]],
           median_cumulative_array_R0lowA,median_cumulative_array_R0lowB,median_cumulative_array_R0lowC,
           cumulative_array_R0lowA,cumulative_array_R0lowB,cumulative_array_R0lowC)

f_4_high<- make_fig_4(f_1_high[[2]],f_1_high[[3]],f_1_high[[4]],
           median_cumulative_array_R0highA,median_cumulative_array_R0highB,median_cumulative_array_R0highC,
           cumulative_array_R0highA,cumulative_array_R0highB,cumulative_array_R0highC)

```



```{r,message=FALSE, echo=FALSE, warning=FALSE, fig.align="center", fig.dim = c(6,10), fig.cap="Figure 4."}

plt <- cowplot::plot_grid(f_4_low[[1]] , f_4_low[[2]], f_4_low[[3]], labels=c('A','B','C'), align = "h", nrow=3)
print(plt)

```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>

<div class = "row"><div class = "row-md-6"><div class = "blue">
- These results suggest that in a low transmission scenario with no intervention or a mildly restrictive intervention strategy,  hospital capacity may be reached in June assuming there are around 4,000 hospital beds in Baltimore City. 
- If we assume there are 600 ventilators in Baltimore City, we may reach ventilator capacity by May if no intervention or mildly restrictive intervention strategies are imposed.
- With moderately restrictive intervention strategies, capacity may not be reached in the low transmission scenario.
</div></div>

<br><br>

**Figure 5**. Daily A) hospital beds, B) ICU beds, and C) ventilators in use for the high transmission scenario for each intervention strategy. The dark line represents the median of 500 simulations per strategy and scenario and the dotted lines represent the 15 random simulations.

```{r,message=FALSE, echo=FALSE, warning=FALSE, fig.align="center",  fig.dim = c(6,10), fig.cap="Figure 5."}

plt <- cowplot::plot_grid(f_4_high[[1]] , f_4_high[[2]], f_4_high[[3]], labels=c('A','B','C'), align = "h", nrow=3)
print(plt)

```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>

<div class = "row"><div class = "row-md-6"><div class = "blue">
- These results suggest that in a high transmission scenario with no intervention or a mildly restrictive intervention strategy,  hospital capacity may be reached before mid-May. 
- If we assume there are 600 ventilators in Baltimore City, we may reach ventilator capacity by mid-April if no intervention or mildly restrictive intervention strategies are imposed.
- With moderately restrictive intervention strategies, capacity may not be reached until the fall in the high transmission scenario.
</div></div>

<br><br>


 -------------------------------

*Question 3: What is the total impact of COVID-19 in Baltimore City?*



**Figure 6**. The cumulative number of A) cases and B) deaths in the low transmission scenario considering each intervention strategy. The line represents the median of 500 simulations per strategy and scenario.

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.align="center", fig.width=6, fig.height=10, fig.cap="Figure 5."}

make_fig_5<- function(combined_data_1,combined_data_2,combined_data_3,
                      cumulative_data_1,cumulative_data_2,cumulative_data_3){
daily_incident_cases<- matrix(NA,nrow(combined_data_1),ncol=4)

daily_incident_cases[,1]<- combined_data_1[,1]
daily_incident_cases[,2]<- apply(combined_data_1[,-1],1,sum)
daily_incident_cases[,3]<- apply(combined_data_2[,-1],1,sum)
daily_incident_cases[,4]<- apply(combined_data_3[,-1],1,sum)

cumulative_cases_symptomatic<- matrix(NA, nrow(daily_incident_cases), ncol(daily_incident_cases))
cumulative_cases_symptomatic[,1]<- combined_data_1[,1]
cumulative_cases_symptomatic[which(cumulative_cases_symptomatic[,1]==1),]<- 
  daily_incident_cases[which(daily_incident_cases[,1]==1),]
for(i in 2:n_days){
  for(j in 2: ncol(daily_incident_cases)){
    cumulative_cases_symptomatic[which(cumulative_cases_symptomatic[,1]==i),j]<-
      cumulative_cases_symptomatic[which(cumulative_cases_symptomatic[,1]==(i-1)),j]+
      daily_incident_cases[which(daily_incident_cases[,1]==i),j]
  }
  
}

median_cumulative_cases_symptomatic<- matrix(NA, n_days, ncol= 4)

median_cumulative_cases_symptomatic[,1]<- rep(1:n_days)
for(i in 1:nrow(median_cumulative_cases_symptomatic)){
  median_cumulative_cases_symptomatic[i,-1]<- 
    apply(cumulative_cases_symptomatic[which(cumulative_cases_symptomatic[,1]==i),-1],2,median)
}

cumulative_cases_symptomatic<- as.data.frame(median_cumulative_cases_symptomatic)
colnames(cumulative_cases_symptomatic)<- c("Day", "Uncontrolled",
                                          "Mildly restrictive", "Moderately restrictive")

cumulative_cases_symptomatic_long<- cumulative_cases_symptomatic%>%
  gather(scenario, cumulative_cases, "Uncontrolled": "Moderately restrictive", factor_key = T)%>%
  mutate(Day= rep(seq(as.Date('2020/02/1'),by="day", length.out = n_days),3))

cumulative_symptomatic_cases_plt<- ggplot(cumulative_cases_symptomatic_long)+
  geom_line(aes(x=Day, y= cumulative_cases, color=scenario))+
  labs(y="Cumulative Symptomatic Cases", title= "Cumulative Symptomatic Cases",
       color="Strategy")

#cumulative deaths
cumulative_deaths<- as.data.frame(cbind(rep(1:nrow(cumulative_data_1[,,5])),
                    apply(cumulative_data_1[,-1,5],1,sum),
                    apply(cumulative_data_2[,-1,5],1,sum),
                    apply(cumulative_data_3[,-1,5],1,sum)))


median_cumulative_deaths<- matrix(NA, n_days, 4)
median_cumulative_deaths[,1]<- rep(1:n_days)
for(i in 1:nrow(median_cumulative_deaths)){

    median_cumulative_deaths[i,-1]<- 
      apply(cumulative_deaths[which(cumulative_deaths[,1]==i),-1],2,median)
  
}

median_cumulative_deaths<- as.data.frame(median_cumulative_deaths)
colnames(median_cumulative_deaths)<- c("Day", "Uncontrolled",
                                          "Mildly restrictive", "Moderately restrictive")

median_cumulative_deaths_long<- median_cumulative_deaths%>%
  gather(scenario, cumulative_death, "Uncontrolled": "Moderately restrictive", factor_key = T)%>%
   mutate(Day= rep(seq(as.Date('2020/02/1'),by="day", length.out = n_days),3))

cumulative_deaths_plot<- ggplot(median_cumulative_deaths_long)+
  geom_line(aes(x=Day, y= cumulative_death, color=scenario))+
  labs(y= "Cumulative Deaths", title="Cumulative Deaths",color="Strategy")

return(list(cumulative_symptomatic_cases_plt,cumulative_deaths_plot))
}

#max <- cumulative_cases_symptomatic_long %>% group_by(scenario) %>% dplyr::summarize(max=max(cumulative_cases,na.rm=TRUE)) %>% ungroup
#max <- median_cumulative_deaths_long %>% group_by(scenario) %>% dplyr::summarize(max=max(cumulative_death,na.rm=TRUE)) %>% ungroup

f_5_low<- make_fig_5(combined_incident_R0lowA,combined_incident_R0lowB,combined_incident_R0lowC,
                 cumulative_array_R0lowA,cumulative_array_R0lowB,cumulative_array_R0lowC)

f_5_high<- make_fig_5(combined_incident_R0highA,combined_incident_R0highB,combined_incident_R0highC,
                 cumulative_array_R0highA,cumulative_array_R0highB,cumulative_array_R0highC)

```



```{r,message=FALSE, echo=FALSE, warning=FALSE, fig.align="center", fig.dim = c(6,10), fig.cap="Figure 6."}

plt <- cowplot::plot_grid(f_5_low[[1]] , f_5_low[[2]], labels=c('A','B'), align = "h", nrow=2)
print(plt)

```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>

<div class = "row"><div class = "row-md-6"><div class = "blue">
- We expect over 173,00 cumulative infections and 48,000 cumulative deaths in Baltimore City in a low transmission scenario with no intervention or mildly restrictive strategies by fall of 2020.
- If moderately restrictive intervention strategies are imposed, we expect to see a significant reduction in the cumulative number of cases (~733) and deaths (~294).
</div></div>

<br><br>

**Figure 7**. The cumulative number of A) cases and B) deaths in the high transmission scenario considering each intervention strategy. The line represents the median of 500 simulations per strategy and scenario.

```{r,message=FALSE, echo=FALSE, warning=FALSE, fig.align="center",  fig.dim = c(6,10), fig.cap="Figure 7."}

plt <- cowplot::plot_grid(f_5_high[[1]] , f_5_high[[2]], labels=c('A','B'), align = "h", nrow=2)
print(plt)

```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>

<div class = "row"><div class = "row-md-6"><div class = "blue">
- We expect over 231,000 cumulative infections and 66,500 cumulative deaths in Baltimore City in a high transmission scenario with no intervention or mildly restrictive strategies by July of 2020.
- If moderately restrictive intervention strategies are imposed, we expect to see a significant reduction in the cumulative number of cases (~40,800) and deaths (~10,200).
</div></div>

<br><br>

 -------------------------------

##### Technical Appendix

Below we list the more detailed assumptions used in our model. First, we make the following assumptions for the inital conditions in our SEIR model:

(1) We assume the following age categories: 0-19, 20-44, 45-54, 55-74, 75+. We also model healthcare workers and homeless populations as separate population categories. 
(2) We assume age-structured mixing in the population and seed the epidemic with age-specific asymptomatic:symptomatic case ratios. Healthcare workers and the homeless population are considered as explicit populations that follow the mixing patterns of the 45-54 year age category.  
(3) We assume the age structure of Baltimore City using data from the 2010 Baltimore census, and assume the population of healthcare workers is 5,000 and the population of individuals who are homeless is 3,000. 
(4) The distribution of $R_0$ used in our two transmission scenarios fall within the 95% confidence interval of the curent range of $R_0$ [estimates for COVID-19](https://github.com/midas-network/COVID-19/tree/master/parameter_estimates/2019_novel_coronavirus). 


For the projected outputs we create a probability matrix of working probabilities from the literature for the likelihood of becoming a hospitalized case, getting admitted to ICU, needing a ventilator and dying. These are nested conditional probabilities that rely on the following assumptions:

- The percentage of hospitalized cases in each category is obtained from the [CDC](https://www.cdc.gov/mmwr/volumes/69/wr/mm6912e2.htm#T1_down) where we combined the 55-74 age groups and the 75-80 and 80+ age groups.
- We assume the remainder of the nested probabilities from the [CDC](https://www.cdc.gov/mmwr/volumes/69/wr/mm6912e2.htm#T1_down) and in each subsequent state (hospitalization to ICU, ICU to death) we shift the denominator to be the preceding state's total (e.g. the probability of getting admitted to the ICU is the number of ICU cases for the age group/number of hospitalized cases for the age group).
- We assume a global probability that 25% of cases admitted to the ICU require a ventilator per [WHO reports](https://www.who.int/publications-detail/report-of-the-who-china-joint-mission-on-coronavirus-disease-2019-(covid-19)).  
- We assume healthcare workers and the homeless population follow a similar nested probability scheme as those in the 45-54 year age group.

*Note: Instead of having just a point estimate from the CDC table as described we take this point estmate to be the mean of a beta distribution, where the second shape parameter is 1. The first shape parameter is then defined by (mean)/(1-mean) where the mean is the point estimate of the nested probability obtained from the CDC table.* 

To determine which time step each event (i.e. hospitalization, ICU admission, ventilation, death) occurs, we incoporate time lags in the multiplication of the probabilities estimated for each simulation independently. Currently, these are point estimates but you can change these to distributions. We make the following assumptions with respect to how much time people spend in each condition:

- We assume the same time lags for each condition across population categories.
- There is a 4 day lag between illness onset and becoming hospitalized (i.e. being identified as an incident case and getting hospitalized). We base this on data from [Wuhan](https://www.medrxiv.org/content/10.1101/2020.03.03.20028423v3).
- There is an 8 day lag from time admitted to ICU to death and 4.5 day lag from time of ventilation to death. We base this on data from [Wuhan](https://www.thelancet.com/action/showPdf?pii=S0140-6736%2820%2930566-3) as well.
- For those who recover, there is an 11 day lag from the time of hospitalization to discharge and time of ventilation to discharge.This estimate is based on expert clinical opinion.

For the computation of summary statistics, we estimate the median, 75th and 25th quantiles across simulations to determine the number of incident events and cumulative case counts. Throughout this document, we display uncertainty as 15 random simulations chosen from the total set of simulations. It is possible to improve uncertainty estimation methods and use bootstrapping techniques across simulations to define a median, minimum and maximum value. However, as this document is for planning purposes this is not immediately necessary.




```{r, include=FALSE, eval=FALSE}

# Figure 5
cumulative_hosp_R_017<- as.data.frame(cbind(rep(1:nrow(cumulative_array_median_R017_75[,,2])),
                                        cumulative_array_median_R017_75[,,2]))


colnames(cumulative_hosp_R_017)<- c('Day', "Age0-19",
                                      "Age20-34", "Age35-59", "Age60-74", "Age75+",
                                      "HCW", "Homeless")

cumulative_hosp_R_017_long<- gather(cumulative_hosp_R_017, age_group, cumulative_hosp,
                                      "Age0-19":"Homeless",factor_key=TRUE)

cumulative_hosp_R_017_long<- cumulative_hosp_R_017_long%>%
  mutate(Day= rep(seq(as.Date('2020/03/1'),by='day', 
                      length.out=nrow(cumulative_array_median_R017_75[,,5])),times=7))


plt_cumulative_hosp_by_R_017<- ggplot(cumulative_hosp_R_017_long)+
  geom_line(aes(x=Day,y=cumulative_hosp,color=age_group))+
  labs(y="Number of hospital beds in use per day", title="Low transmission") + ylim(0,360) + labs(color="Age group")

plt_A<-plt_cumulative_hosp_by_R_017

cumulative_hosp_R_021<- as.data.frame(cbind(rep(1:nrow(cumulative_array_median_R021_75[,,2])),
                                        cumulative_array_median_R021_75[,,2]))


colnames(cumulative_hosp_R_021)<- c('Day', "Age0-19",
                                      "Age20-34", "Age35-59", "Age60-74", "Age75+",
                                      "HCW", "Homeless")

cumulative_hosp_R_021_long<- gather(cumulative_hosp_R_021, age_group, cumulative_hosp,
                                      "Age0-19":"Homeless",factor_key=TRUE)

cumulative_hosp_R_021_long<- cumulative_hosp_R_021_long%>%
  mutate(Day= rep(seq(as.Date('2020/03/1'),by='day', 
                      length.out=nrow(cumulative_array_median_R017_75[,,5])),times=7))



plt_cumulative_hosp_by_R_021<- ggplot(cumulative_hosp_R_021_long)+
  geom_line(aes(x=Day,y=cumulative_hosp,color=age_group))+
  labs(y="Number of hospital beds in use per day", title="Moderate transmission") + ylim(0,360) + labs(color="Age group")

plt_B<-plt_cumulative_hosp_by_R_021

cumulative_hosp_R_025<- as.data.frame(cbind(rep(1:nrow(cumulative_array_median_R025_75[,,2])),
                                        cumulative_array_median_R025_75[,,2]))


colnames(cumulative_hosp_R_025)<- c('Day', "Age0-19",
                                      "Age20-34", "Age35-59", "Age60-74", "Age75+",
                                      "HCW", "Homeless")

cumulative_hosp_R_025_long<- gather(cumulative_hosp_R_025, age_group, cumulative_hosp,
                                      "Age0-19":"Homeless",factor_key=TRUE)

cumulative_hosp_R_025_long<- cumulative_hosp_R_025_long%>%
  mutate(Day= rep(seq(as.Date('2020/03/1'),by='day', 
                      length.out=nrow(cumulative_array_median_R017_75[,,5])),times=7))


plt_cumulative_hosp_by_R_025<- ggplot(cumulative_hosp_R_025_long)+
  geom_line(aes(x=Day,y=cumulative_hosp,color=age_group))+
  labs(y="Number of hospital beds in use per day", title="High transmission") + ylim(0,360) + labs(color="Age group")

plt_C<-plt_cumulative_hosp_by_R_025

############
cumulative_ICU_R_017<- as.data.frame(cbind(rep(1:nrow(cumulative_array_median_R017_75[,,3])),
                                        cumulative_array_median_R017_75[,,3]))


colnames(cumulative_ICU_R_017)<- c('Day', "Age0-19",
                                      "Age20-34", "Age35-59", "Age60-74", "Age75+",
                                      "HCW", "Homeless")

cumulative_ICU_R_017_long<- gather(cumulative_ICU_R_017, age_group, cumulative_ICU,
                                      "Age0-19":"Homeless",factor_key=TRUE)

cumulative_ICU_R_017_long<- cumulative_ICU_R_017_long%>%
  mutate(Day= rep(seq(as.Date('2020/03/1'),by='day', 
                      length.out=nrow(cumulative_array_median_R017_75[,,5])),times=7))


plt_cumulative_ICU_by_R_017<- ggplot(cumulative_ICU_R_017_long)+
  geom_line(aes(x=Day,y=cumulative_ICU,color=age_group))+
  labs(y="Number of ICU beds in use per day", title="Low transmission") + ylim(0,200) + labs(color="Age group")

plt_D<-plt_cumulative_ICU_by_R_017

cumulative_ICU_R_021<- as.data.frame(cbind(rep(1:nrow(cumulative_array_median_R021_75[,,3])),
                                        cumulative_array_median_R021_75[,,3]))


colnames(cumulative_ICU_R_021)<- c('Day', "Age0-19",
                                      "Age20-34", "Age35-59", "Age60-74", "Age75+",
                                      "HCW", "Homeless")

cumulative_ICU_R_021_long<- gather(cumulative_ICU_R_021, age_group, cumulative_ICU,
                                      "Age0-19":"Homeless",factor_key=TRUE)


cumulative_ICU_R_021_long<- cumulative_ICU_R_021_long%>%
  mutate(Day= rep(seq(as.Date('2020/03/1'),by='day', 
                      length.out=nrow(cumulative_array_median_R017_75[,,5])),times=7))


plt_cumulative_ICU_by_R_021<- ggplot(cumulative_ICU_R_021_long)+
  geom_line(aes(x=Day,y=cumulative_ICU,color=age_group))+
  labs(y="Number of ICU beds in use per day", title="Moderate transmission") + ylim(0,200) + labs(color="Age group")

plt_E<-plt_cumulative_ICU_by_R_021


cumulative_ICU_R_025<- as.data.frame(cbind(rep(1:nrow(cumulative_array_median_R025_75[,,3])),
                                        cumulative_array_median_R025_75[,,3]))


colnames(cumulative_ICU_R_025)<- c('Day', "Age0-19",
                                      "Age20-34", "Age35-59", "Age60-74", "Age75+",
                                      "HCW", "Homeless")

cumulative_ICU_R_025_long<- gather(cumulative_ICU_R_025, age_group, cumulative_ICU,
                                      "Age0-19":"Homeless",factor_key=TRUE)


cumulative_ICU_R_025_long<- cumulative_ICU_R_025_long%>%
  mutate(Day= rep(seq(as.Date('2020/03/1'),by='day', 
                      length.out=nrow(cumulative_array_median_R017_75[,,5])),times=7))


plt_cumulative_ICU_by_R_025<- ggplot(cumulative_ICU_R_025_long)+
  geom_line(aes(x=Day,y=cumulative_ICU,color=age_group))+
  labs(y="Number of ICU beds in use per day", title="High transmission") + ylim(0,200) + labs(color="Age group")

plt_F<-plt_cumulative_ICU_by_R_025
##################

cumulative_vent_R_017<- as.data.frame(cbind(rep(1:nrow(cumulative_array_median_R017_75[,,4])),
                                        cumulative_array_median_R017_75[,,4]))


colnames(cumulative_vent_R_017)<- c('Day', "Age0-19",
                                      "Age20-34", "Age35-59", "Age60-74", "Age75+",
                                      "HCW", "Homeless")

cumulative_vent_R_017_long<- gather(cumulative_vent_R_017, age_group, cumulative_vent,
                                      "Age0-19":"Homeless",factor_key=TRUE)


cumulative_vent_R_017_long<- cumulative_vent_R_017_long%>%
  mutate(Day= rep(seq(as.Date('2020/03/1'),by='day', 
                      length.out=nrow(cumulative_array_median_R017_75[,,5])),times=7))


plt_cumulative_vent_by_R_017<- ggplot(cumulative_vent_R_017_long)+
  geom_line(aes(x=Day,y=cumulative_vent,color=age_group))+
  labs(y="Number of vents in use per day", title="Low transmission") + ylim(0,150) + labs(color="Age group")

plt_G <-plt_cumulative_vent_by_R_017

cumulative_vent_R_021<- as.data.frame(cbind(rep(1:nrow(cumulative_array_median_R021_75[,,4])),
                                        cumulative_array_median_R021_75[,,4]))


colnames(cumulative_vent_R_021)<- c('Day', "Age0-19",
                                      "Age20-34", "Age35-59", "Age60-74", "Age75+",
                                      "HCW", "Homeless")

cumulative_vent_R_021_long<- gather(cumulative_vent_R_021, age_group, cumulative_vent,
                                      "Age0-19":"Homeless",factor_key=TRUE)
cumulative_vent_R_021_long<- cumulative_vent_R_021_long%>%
  mutate(Day= rep(seq(as.Date('2020/03/1'),by='day', 
                      length.out=nrow(cumulative_array_median_R017_75[,,5])),times=7))

plt_cumulative_vent_by_R_021<- ggplot(cumulative_vent_R_021_long)+
  geom_line(aes(x=Day,y=cumulative_vent,color=age_group))+
  labs(y="Number of vents in use per day", title="Moderate transmission") + ylim(0,150) + labs(color="Age group")

plt_H <-plt_cumulative_vent_by_R_021

cumulative_vent_R_025<- as.data.frame(cbind(rep(1:nrow(cumulative_array_median_R025_75[,,4])),
                                        cumulative_array_median_R025_75[,,4]))


colnames(cumulative_vent_R_025)<- c('Day', "Age0-19",
                                      "Age20-34", "Age35-59", "Age60-74", "Age75+",
                                      "HCW", "Homeless")

cumulative_vent_R_025_long<- gather(cumulative_vent_R_025, age_group, cumulative_vent,
                                      "Age0-19":"Homeless",factor_key=TRUE)
cumulative_vent_R_025_long<- cumulative_vent_R_025_long%>%
  mutate(Day= rep(seq(as.Date('2020/03/1'),by='day', 
                      length.out=nrow(cumulative_array_median_R017_75[,,5])),times=7))


plt_cumulative_vent_by_R_025<- ggplot(cumulative_vent_R_025_long)+
  geom_line(aes(x=Day,y=cumulative_vent,color=age_group))+
  labs(y="Number of vents in use per day", title="High transmission") + ylim(0,150) + labs(color="Age group")

plt_I <- plt_cumulative_vent_by_R_025

fig_nums(name = paste0("fig-five"), caption = paste("A,B,C. Plots of daily hospital beds needed by transmission scenario and population category. D,E,F. Plots of daily ICU beds needed by transmission scenario and population category. G,H,I. Plots of daily ventilators needed by transmission scenario and population category."), display = "false")

plt <- cowplot::plot_grid(plt_A, plt_B, plt_C, plt_D, plt_E, plt_F, plt_G, plt_H, plt_I, labels=c('A', 'B','C','D','E','F','G','H','I'), align = "h", nrow=3)
print(plt)
```



